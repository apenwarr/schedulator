<script>
    flip_row = function(e, parentdepth, nchildren) {
	var row = $(e).closest('tr')
        var was_collapsed = row.hasClass("collapsed");
	var subs = row.nextAll().slice(0,nchildren);
	if (was_collapsed) {
	    row.removeClass("collapsed").addClass("expanded");
	    subs.addClass("collapsed")
		.filter('.depth-' + (parentdepth+1))
		.show();
	} else {
	    row.addClass("collapsed").removeClass("expanded");
	    subs.addClass("collapsed").removeClass("expanded")
		.hide();
	}
	return false;
    }

    {% if not user %}
    $(function() {
        $('#schedule tr td').parent().each(function() {
	    $(this).addClass("collapsed").removeClass("expanded");
	    if (!$(this).hasClass("depth-1")) {
	        $(this).hide();
	    }
	});
    });
    {% end %}
</script>

<style>
  #schedule {
      width: 90%;
  }
  #schedule th {
      text-align: left;
  }
  #schedule tr:hover {
      background: #dddddd;
  }
  #schedule tr.done td {
      text-decoration: line-through;
      color: #888888;
  }
  #schedule tr.late .duedate {
      color: red;
  }
  #schedule tr.expanded .summary {
      visibility: hidden;
  }
  #schedule .title .ui-icon {
      float: left;
      margin-left: -20px;
      margin-top: 3px;
      background-position: -48px -16px;
  }
  #schedule .collapsed .title .ui-icon {
      background-position: -32px -16px;
  }
  #schedule .depth-1 .title {
      padding-left: 0em;
  }
  #schedule .depth-2 .title {
      padding-left: 3em;
  }
  #schedule .depth-3 .title {
      padding-left: 6em;
  }
  #schedule .depth-4 .title {
      padding-left: 9em;
  }
  #schedule .depth-5 .title {
      padding-left: 12em;
  }
  #schedule .depth-6 .title {
      padding-left: 15em;
  }
  #schedule .depth-7 .title {
      padding-left: 18em;
  }
  #schedule .note {
      display: block;
      padding-left: 2em;
      font-size: 90%;
      font-style: italic;
      color: #222222;
  }
  #schedule .summary {
      white-space: nowrap;
  }
</style>

  <table id='schedule'>
      <tr>
 	  <th>Task</th>
 	  <th>CurrEst</th>
 	  <th>Elapsed</th>
 	  <th>Remain</th>
 	  <th>Due</th>
       	  {% if not user %}<th>Owner</th>{% end %}
      </tr>
      {% for t in tasks.linearize() %}
        {% if t.contains_user(user) %}
          <tr class="depth-{{t.depth()}} {% if t.donedate %}done{% end %} {% if not t.donedate and t.late() %}late{% end %} {% if t.total_children(user) %}expanded{% end %}">
 	    <td class="title">
	        {% if t.subtasks %}
	        <a href="#" onClick="return flip_row(this, {{t.depth()}}, {{t.total_children(user)}});"
		><span class="ui-icon"></span>{{t.title}}</a>
		{% else %}
		{{t.title}}
		{% end %}
		{% if t.note %}<span class="note">{{t.note}}</span>{% end %}
 	    </td>
 	    <td class="summary">{{render_est(t.total_estimate())}}</td>
 	    <td class="summary">{{render_est(t.total_elapsed())}}</td>
 	    <td class="summary">{{render_est(t.total_remain())}}</td>
 	    <td class="duedate summary">{{t.duedate}}</td>
	    {% if not user %}
	    <td class="summary">{{t.owner and t.owner.name or ''}}</td>
	    {% end %}
	  </tr>
	{% end %}
      {% end %}
  </table>
